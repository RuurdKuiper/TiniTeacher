<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Curriculum Viewer</title>
<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    height: 100vh;
    display: flex;
    overflow: hidden;
}

/* Sidebar container */
#sidebar {
    display: flex;
    flex-direction: row;
    height: 100%;
    background: #f9f9f9;
    border-right: 1px solid #ccc;
    transition: width 0.3s;
    overflow-x: auto;
}

/* Each layer column */
.menu-column {
    display: flex;
    flex-direction: column;
    padding: 10px;
    min-width: 100px;
    max-width: 180px;
    border-right: 1px solid #ddd;
    overflow-y: auto;
}

/* Button styling */
.menu-btn {
    display: flex;
    align-items: center;
    cursor: pointer;
    margin-bottom: 8px;
    padding: 4px;
    border-radius: 8px;
    transition: all 0.2s;
}
.menu-btn img {
    width: 50px;
    height: 50px;
    object-fit: contain;
    margin-right: 10px;
    border-radius: 6px;
}
.menu-btn span {
    font-weight: 500;
    font-size: 14px;
    max-width: 130px;
    word-wrap: break-word;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Selected button highlight */
.menu-btn.selected {
    border: 2px solid #007bff;
    box-shadow: 0 0 10px rgba(0,123,255,0.5);
}

/* Lesson content area */
#lesson-container {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    background: #fff;
}

/* Bite / quiz styling */
.bite, .quiz { border:1px solid #ccc; padding:10px; margin-bottom:10px; }

/* Collapsible toggle */
#collapse-btn {
    position: absolute;
    top: 10px;
    left: 5px;
    z-index: 100;
    background: #007bff;
    color: white;
    border: none;
    padding: 4px 8px;
    cursor: pointer;
    border-radius: 4px;
}
</style>
</head>
<body>

<button id="collapse-btn">â˜°</button>

<div id="sidebar">
    <div id="subject-row" class="menu-column"></div>
    <div id="course-row" class="menu-column hidden"></div>
    <div id="lesson-row" class="menu-column hidden"></div>
    <div id="level-row" class="menu-column"></div>
</div>

<div id="lesson-container" class="hidden">
    <div id="bite-container"></div>
    <div id="quiz-container" class="hidden"></div>
    <div id="nav-buttons">
        <button id="prev-btn">Previous</button>
        <button id="next-btn">Next</button>
    </div>
</div>

<!-- Only the JS part is updated, rest stays the same -->
<script>
// Collapse functionality (unchanged)
const sidebar = document.getElementById('sidebar');
const collapseBtn = document.getElementById('collapse-btn');
let collapsed = false;
collapseBtn.onclick = () => {
    collapsed = !collapsed;
    sidebar.style.width = collapsed ? '40px' : 'auto';
    document.querySelectorAll('.menu-column').forEach(col => {
        col.style.display = collapsed ? 'none' : 'flex';
    });
};

// Curriculum logic (mostly unchanged)
let curriculum={}, currentLevel='ELI5', currentLesson=null, currentCourse=null, currentSubject=null;
let biteIndex=0, quizIndex=0, inQuiz=false;
const levels=['ELI5','ELI12','ELI16','ELI25'];

async function loadSubjects() {
    const subjectFiles = [
        'generated_curriculum/bio.json','generated_curriculum/chem.json','generated_curriculum/math.json',
        'generated_curriculum/cs.json','generated_curriculum/phys.json','generated_curriculum/phil.json',
        'generated_curriculum/geo.json','generated_curriculum/hist.json'
    ];
    curriculum={subjects:[]};
    for(const file of subjectFiles){
        const data = await (await fetch(file)).json();
        curriculum.subjects.push(data.subjects[0]);
    }
    renderSubjects();
    renderLevels();
}

// Generic render function (unchanged)
function renderButtons(containerId, items, current, clickHandler, type) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    items.forEach(item=>{
        const btn = document.createElement('div');
        btn.className = 'menu-btn '+type + (current===item?' selected':'');
        const img = document.createElement('img');
        let imgPath = '';
        if(type==='subject'){
            imgPath = `images/${item.short}/${item.short}_icon.png`;
        } else if(type==='course'){
            imgPath = `images/${currentSubject.short}/${item.short}/${item.short}_icon.png`;
        } else if(type==='lesson'){
            imgPath = `images/${currentSubject.short}/${currentCourse.short}/${item.lesson_id}_icon.png`;
        } else if(type==='level'){
            imgPath = `images/${item}_icon.png`;
        }
        img.src = imgPath;
        img.alt = item.name || item.title || item;
        img.onerror=function(){this.onerror=null;this.src='images/placeholder.png'};
        const span = document.createElement('span');
        span.textContent=item.name || item.title || item;
        btn.appendChild(img);
        btn.appendChild(span);
        btn.onclick = ()=>clickHandler(item);
        container.appendChild(btn);
    });
    container.classList.remove('hidden');
}

// Subject rendering
function renderSubjects(){
    renderButtons('subject-row', curriculum.subjects, currentSubject, sub=>{
        currentSubject=sub; 
        currentCourse=null; 
        currentLesson=null;
        biteIndex=0; quizIndex=0; inQuiz=false; // <-- reset indices
        document.getElementById('course-row').innerHTML=''; 
        document.getElementById('course-row').classList.add('hidden');
        document.getElementById('lesson-row').innerHTML=''; 
        document.getElementById('lesson-row').classList.add('hidden');
        document.getElementById('lesson-container').classList.add('hidden'); // <-- hide content
        document.getElementById('bite-container').innerHTML='';   // clear previous bite
        document.getElementById('quiz-container').innerHTML='';   // clear previous quiz
        renderSubjects();
        renderCourses(sub);
    },'subject');
}


// Course rendering
function renderCourses(subject){
    renderButtons('course-row', subject.courses, currentCourse, c=>{
        currentCourse=c; 
        currentLesson=null;
        biteIndex=0; quizIndex=0; inQuiz=false; // <-- reset indices
        document.getElementById('lesson-row').innerHTML=''; 
        document.getElementById('lesson-row').classList.add('hidden');
        document.getElementById('lesson-container').classList.add('hidden'); // <-- hide content
        document.getElementById('bite-container').innerHTML='';   // clear previous bite
        document.getElementById('quiz-container').innerHTML='';   // clear previous quiz
        renderCourses(subject);
        renderLessons(subject,c);
    },'course');
}


// Lesson rendering
function renderLessons(subject,course){
    renderButtons('lesson-row', course.lessons, currentLesson, lesson=>{
        currentLesson=lesson; 
        biteIndex=0; 
        quizIndex=0; 
        inQuiz=false; // <-- reset quiz mode when switching lessons
        renderLessons(subject,course);
        document.getElementById('lesson-container').classList.remove('hidden');
        document.getElementById('bite-container').innerHTML='';   // clear previous bite
        document.getElementById('quiz-container').innerHTML='';   // clear previous quiz
        renderLesson();
    },'lesson');
}


// Level rendering
function renderLevels(){
    renderButtons('level-row', levels, currentLevel, lvl=>{
        currentLevel=lvl;
        renderLevels();
        if(currentLesson) renderLesson();
    },'level');
}

// Lesson display logic
function renderLesson(){
    const biteContainer=document.getElementById('bite-container');
    const quizContainer=document.getElementById('quiz-container');
    if(!inQuiz){
        const bite=currentLesson.bites[biteIndex];
        const explanation=bite.explanations[currentLevel];
        const imgPath=`images/${currentSubject.short}/${currentCourse.short}/${bite.bite_id}.png`;
        biteContainer.innerHTML=`<div class="bite"><strong>Bite ${biteIndex+1}:</strong><p>${explanation}</p><img src="${imgPath}" style="max-width:300px;margin-top:10px;" onerror="this.style.display='none'"></div>`;
        quizContainer.classList.add('hidden');
    } else {
        const quiz=currentLesson.quizzes[quizIndex];
        let optionsHTML='';
        quiz.options[currentLevel].forEach((o,i)=>{ optionsHTML+=`<label><input type="radio" name="quiz" value="${i}"> ${o}</label><br>`; });
        quizContainer.innerHTML=`<div class="quiz"><strong>Quiz ${quizIndex+1}:</strong><p>${quiz.questions[currentLevel]}</p>${optionsHTML}<div id="feedback" style="margin-top:5px;font-weight:bold;"></div></div>`;
        quizContainer.classList.remove('hidden'); biteContainer.innerHTML='';
        document.querySelectorAll('input[name="quiz"]').forEach(input=>{
            input.addEventListener('change',function(){
                const feedbackDiv=document.getElementById('feedback');
                const selected=parseInt(this.value);
                const correct=currentLesson.quizzes[quizIndex].correct_answers[currentLevel];
                feedbackDiv.textContent=(selected===correct)?"Correct!":`Incorrect. Correct answer: ${currentLesson.quizzes[quizIndex].options[currentLevel][correct]}`;
                feedbackDiv.style.color=(selected===correct)?"green":"red";
            });
        });
    }
}

// Navigation
document.getElementById('next-btn').addEventListener('click',()=>{
    if(!currentLesson) return;
    if(!inQuiz){
        if(biteIndex < currentLesson.bites.length-1){
            biteIndex++;
        } else if(currentLesson.quizzes && currentLesson.quizzes.length>0){
            inQuiz=true; quizIndex=0;   // Move to first quiz
        } else return;
    } else {
        if(quizIndex < currentLesson.quizzes.length-1){
            quizIndex++;
        } else return; // end of lesson
    }
    renderLesson();
});

document.getElementById('prev-btn').addEventListener('click',()=>{
    if(!currentLesson) return;
    if(inQuiz){
        if(quizIndex>0){
            quizIndex--;
        } else {
            inQuiz=false;
            biteIndex=currentLesson.bites.length-1;
            document.getElementById('quiz-container').innerHTML='';   // clear quiz
            document.getElementById('quiz-container').classList.add('hidden');
        }
    } else if(biteIndex>0) {
        biteIndex--;
    }
    renderLesson();
});


loadSubjects();
</script>

</body>
</html>
